<!doctype html><html lang=ja><head>
<meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge,chrome=1">
<meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1">
<link rel=stylesheet href=/sass/main.min.ebf953826ec39760c462d7fdf952404c734dabd6003b608b954f4693f77d2b3f.css>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/katex.min.css integrity=sha384-KiWOvVjnN8qwAZbuQyWDIbfCLFhLXNETzBQjA/92pIowpC0d2O3nppDGQVgwd2nB crossorigin=anonymous>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/katex.min.js integrity=sha384-0fdwu/T/EQMsQlrHCCHoH10pkPLlKA1jL5dFyUOvB3lfeT2540/2g6YgSi2BL14p crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/contrib/auto-render.min.js integrity=sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR crossorigin=anonymous onload=renderMathInElement(document.body)></script>
<script defer>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}]})})</script>
<script defer src=/js/prism.min.js></script>
<link rel=stylesheet href=/css/prism.min.css>
</head>
<body>
<main id=content>
<p class=category>
カテゴリー: <a href=/post>post</a>
</p>
<article class=suuri><ul>
<li>go で 1 週間くらいかけて API サーバを書きました。go 以外にも学ぶことが多かったので学んだことを書きます。</li>
<li>作ったアプリは公開範囲が指定できる wiki みたいなものです。</li>
</ul>
<h2 id=-気をつけたこと># 気をつけたこと</h2>
<ul>
<li>以前 go で API サーバを書いたときは Echo や Gorm といったライブラリをふんだんに使用したため、何がなにかわからなくなって途中で挫折しました。それから時がたって、go の界隈の方々の記事、特に mercari 周辺の方々の記事を読み、go の net/http は単体で十分フレームワークなしでいけるという確信を得たので今回以下のようにしばりを決めました。</li>
</ul>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text>- できるだけ標準ライブラリでなんとかする
(作っていくうちに、DB接続のためpostgresのドライバを、セッション管理のためcrypto/mathの2つだけは使うことにしました)
</code></pre></div><ul>
<li>また、どうしても API を生やす作業は終わりが見えなくなるので、仕様書を書いてみることにしました。今回は <a href=https://swagger.io/specification/>OpenAPI</a> を使うことにしました。</li>
<li>まず OpenAPI で一部の API を決める → go を書く → フロントを書く(場合によっては OpenAPI に修正を入れる)というサイクルで徐々に API の定義書と API サーバとフロントを書いていきました。</li>
</ul>
<h2 id=-分かったこと># 分かったこと</h2>
<h2 id=-openapi-で-api-定義を先に書くとフロントエンド部分を高速に実装できる>## OpenAPI で API 定義を先に書くと、フロントエンド部分を高速に実装できる</h2>
<ul>
<li>API 定義ってどう書くのかというと、こう書きます</li>
</ul>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=s2>&#34;/groups&#34;</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>get</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>responses</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=s2>&#34;200&#34;</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=nt>description</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;userの入っているgroupを返却する&#34;</span><span class=w>
</span><span class=w>        </span><span class=nt>content</span><span class=p>:</span><span class=w>
</span><span class=w>          </span><span class=nt>application/json</span><span class=p>:</span><span class=w>
</span><span class=w>            </span><span class=nt>schema</span><span class=p>:</span><span class=w>
</span><span class=w>              </span><span class=nt>$ref</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;#/components/schemas/UserGroups&#34;</span><span class=w>
</span><span class=w>            </span><span class=nt>example</span><span class=p>:</span><span class=w>
</span><span class=w>              </span><span class=nt>user_groups</span><span class=p>:</span><span class=w>
</span><span class=w>                </span>- <span class=s2>&#34;public&#34;</span><span class=w>
</span><span class=w>                </span>- <span class=s2>&#34;myPrivate&#34;</span><span class=w>
</span><span class=w>    </span><span class=nt>security</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=nt>cookieAuth</span><span class=p>:</span><span class=w> </span><span class=p>[]</span><span class=w>
</span></code></pre></div><ul>
<li>これは <code>/groups</code> というパスに対して get でリクエストを送ったときの API サーバの挙動を決めています。</li>
<li>get なので通常パラメータはなく、response だけを定義していること、また securty の項目に決めてあるように cookie が valid でないと response を返さないことを決めています。返却する型は schema として別で記述しています。</li>
<li>こういうものを書いておくと、フロントエンドとバックエンドを別々に実装できます。多くのやり取りを json で統一しておいたので、フロント側でうけとって書く処理も高速に書くことができました。</li>
</ul>
<h2 id=-go-に慣れてなくて戸惑ったポイント>## go に慣れてなくて戸惑ったポイント</h2>
<ul>
<li>TrimLeft の挙動が TrimPrefix のようなものを期待していたので戸惑いました。</li>
<li><code>http.HandleFunc</code>に<code>/route/</code>を渡すと<code>/route/a</code>もこれにマッチするので<code>/group/:group_name</code>みたいな可変ルーティングに対応できます。これ知らなくてかなりはまりました。</li>
</ul>
<h2 id=-権限回りは設計が難しい>## 権限回りは設計が難しい</h2>
<ul>
<li>自分が作ったバグを述べます。コードを書きながら最終段階でつじつまの合わない箇所をたくさん発見して困りました。</li>
<li>グループという概念を実装して、グループに記事が属していることでそのグループの人だけ記事を見られるという仕組みにしました。</li>
<li>バグ 1: グループの名前だけチェックしている。</li>
<li>これにより、別グループでもそのグループ名が DB に登録されていれば記事を更新できるので、自分が所属していないグループの記事を荒らすことが可能になります。id をチェックすることで解決しました。</li>
<li>バグ 2: グループの名前と id だけチェックしている。</li>
<li>別のグループの名前を指定すると、自分が所属していないグループに無限に記事を送り込むことができます。これも解決しました。</li>
<li>このように、権限回り、閲覧可能範囲回りで大量にヤバが発生したので QA って大事なんだなあと感じました。</li>
</ul>
<h2 id=-終わりに># 終わりに</h2>
<ul>
<li>とりあえず気合でいってベストプラクティスを気にしなければそれなりの速度で web サービスは作れる。大事なのはリリースしてからバグを取る、脆弱な部分があるかもしれないという不安と戦いながら見切ってリリースして継続的に修正とデプロイを繰り返す心！</li>
<li>まだ怖い部分があるので、デプロイできてないです。直してリリースまで持っていきたい。</li>
</ul>
</article>
<footer>
<p class=license>
This document is licensed under
<a href=https://creativecommons.org/licenses/by/4.0/ target=_blank rel="noopener noreferrer">CC-BY-4.0</a>
</p>
<p class=repository>
<a href=https://github.com/uta8a/discussion/discussions/1 target=_blank rel="noopener noreferrer">discussion</a>にコメントする
</p>
</footer>
</main>
</body>
</html>