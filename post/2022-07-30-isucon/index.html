<!doctype html><html lang=ja><head>
<meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge,chrome=1">
<meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1">
<title>ISUCON12予選で0点だったので反省する</title>
<link rel=stylesheet href=/sass/main.min.8ec18d2efeaa7d2deb1054087c7d904060dfd4014322bd5debece96935389302.css>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/katex.min.css integrity=sha384-KiWOvVjnN8qwAZbuQyWDIbfCLFhLXNETzBQjA/92pIowpC0d2O3nppDGQVgwd2nB crossorigin=anonymous>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/katex.min.js integrity=sha384-0fdwu/T/EQMsQlrHCCHoH10pkPLlKA1jL5dFyUOvB3lfeT2540/2g6YgSi2BL14p crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/contrib/auto-render.min.js integrity=sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR crossorigin=anonymous onload=renderMathInElement(document.body)></script>
<script defer>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}]})})</script>
<script defer src=/js/prism.min.js></script>
<link rel=stylesheet href=/css/prism.min.css>
</head>
<body>
<main id=content>
<p class=category>
カテゴリー: <a href=/post>post</a>
</p>
<article class=suuri><h1 id=isucon12予選で0点だったので反省する>ISUCON12予選で0点だったので反省する</h1>
<p>ブログを書くまでがISUCONです！ということで、点数も低くやれたことも少ないので恥ずかしいところも大きいですが書こうと思います。</p>
<h2 id=概要>概要</h2>
<ul>
<li>SQLiteからMySQLへの移行判断材料が直感に頼っていて計測の結果ではないのがまずかった</li>
<li>複数台構成できたっぽいのは成長だったが、複数台構成にすると決めた判断材料も計測から少しズレた推論の結果なのであまり良くないタイミングだった</li>
<li>次回はもっとアプリケーションコードと当日マニュアルを読んで落ち着いてから計測すると良さそう</li>
</ul>
<h2 id=前提と行った準備>前提と行った準備</h2>
<ul>
<li>ISUCONは今回で3回目
<ul>
<li>初回はISUCON9, 友人とSSHの仕方調べていたら終わった</li>
<li>2回目はISUCON10, 確かSSHの接続の仕方が特殊でようやく接続できた時にはあまり時間がなかった</li>
</ul>
</li>
<li>今回はちょっと頑張りたかったのでISUCON本を読んだ
<ul>
<li>private_isuをAWS環境を立ててなぞった</li>
</ul>
</li>
<li>Goは一通り書けるが、DBに関心が向かないのでN+1の解消とかは分かってない、キャッシュもノータッチという状態</li>
</ul>
<h2 id=当日のタイムライン>当日のタイムライン</h2>
<h3 id=前日>前日</h3>
<p>クーポンを適用する、private repoを作る、最初の一時間ですることを決める</p>
<h3 id=955-予選問題の動画公開>9:55 予選問題の動画公開</h3>
<ul>
<li>エージェント？SPY×FAMILYか？</li>
<li>マルチテナントサービス</li>
<li>ISUPORTS→サービスの名前はMakefileで大事なのでメモ</li>
<li>ISUCON SaaS たくさんの企業がSaaSを使いたい→いい世界線だ</li>
<li>ISUPORTS リーダーボード機能の処理速度に問題がある→ということはリーダーボードに対処するのがメインになりそう</li>
<li>2つ目の問題は開始が8時間後であるということ→これはいつもの問題だな</li>
</ul>
<h3 id=1000-問題公開>10:00 問題公開</h3>
<ul>
<li>当日マニュアルが長い</li>
<li>とりあえずSSHを確認してenv_checkerを全てのインスタンスで回して確認(ハズレインスタンスを引いていたらいけないので)</li>
<li>c5.large 2 4 EBS のみ 最大 10 最大 4,750 x3</li>
<li>IntelマシンなのでArmではない</li>
<li>bench回した</li>
</ul>
<p><img src=image-1.png alt></p>
<ul>
<li>落ち着いて、他のサーバでもbench</li>
<li>初期スコア <strong>2959</strong></li>
</ul>
<h3 id=1030-バックアップ完了>10:30 バックアップ完了</h3>
<ul>
<li><a href=https://trap.jp/post/1614/>traPのISUCON初心者向け講習会</a> でバックアップする方法が書かれていたのでこれを真似する。今回はMySQLとnginx構成なので変更も少ない</li>
<li>ここでappがdockerに乗っていることに気づく。計測ツール入れるのが面倒だと判断してdockerから剥がすことにする。</li>
<li>topの挙動が、mysqlが100%を超えている状態からmain(app)が支配的になるという2つのピークがあるように見える→DBを分離したらいいと思って複数台構成に取り掛かる(この判断は後述するように微妙だったかも)</li>
<li>大量の.dbファイルを発見してオイオイという気持ちになる。これは絶対MySQLに載せるやつやろと判断する(後述するようにこの判断材料が直感なのが良くない)</li>
</ul>
<h3 id=1108-alp一回目回せる>11:08 alp一回目回せる</h3>
<ul>
<li>alpが何も表示されなくて焦っていたが、よく見たらMakefileが途中で失敗して最後まで行かなくて <code>deploy-nginx-conf</code> が動いておらず、設定ファイルが反映されていなかった。</li>
<li>1回目のalpを回す。alpで指定するパスは当日マニュアルの得点に関係しそうなものを手動コピペした</li>
</ul>
<p><img src=image-2.png alt></p>
<ul>
<li>rankingめちゃくちゃ重い。scoreboardに相当しそう。</li>
</ul>
<p><strong>この時点でのやることリスト</strong></p>
<ul>
<li><input disabled type=checkbox> appをdockerから剥がして動作させる</li>
<li><input disabled type=checkbox> rankingに取り組む
<ul>
<li>sqlite3のdb initial_dataをmysqlに入れる。tenant idを保持する方法を考える</li>
<li>移行後DBのIndexをはる</li>
</ul>
</li>
<li><input disabled type=checkbox> docker daemonを切る</li>
</ul>
<h3 id=1200-docker剥がした>12:00 docker剥がした</h3>
<p>dockerをisu1サーバで剥がしてdaemon化した。</p>
<h3 id=1400-バルクインサート失敗>14:00 バルクインサート失敗</h3>
<p>ずっとSQliteからMySQL移行をしていた。一行ずつINSERTでは遅いことがわかったので、バルクインサートをしようとした。</p>
<p>エラーが出た。一行当たり16MBまでしか受け付けないらしい。対象の行は262MBくらいだったのでとりあえず50等分にしてみる</p>
<p>sedに慣れていなくて時間を溶かす</p>
<h3 id=1500-db用サーバを立てる>15:00 DB用サーバを立てる</h3>
<ul>
<li>isu2サーバのdockerを止めてsystemctl disableする</li>
<li>バルクインサートが通らない</li>
</ul>
<h3 id=1630-load-data-infileでmysql移行に成功する>16:30 LOAD DATA INFILEでMySQL移行に成功する(？)</h3>
<p>以下のようなクエリで一番重い player_score の移行に成功した(多分)</p>
<p>アプリ側のコードもそれに合わせて書き換える</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=k>LOAD</span><span class=w> </span><span class=k>DATA</span><span class=w> </span><span class=n>INFILE</span><span class=w> </span><span class=s1>&#39;/var/lib/mysql-files/hoge.csv&#39;</span><span class=w> </span><span class=k>INTO</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=n>player_score</span><span class=w> </span><span class=n>FIELDS</span><span class=w> </span><span class=n>TERMINATED</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=s1>&#39;,&#39;</span><span class=p>;</span><span class=w>
</span></code></pre></div><h3 id=1710-整合性チェックが通らない>17:10 整合性チェックが通らない</h3>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text>Jul 23 08:11:50 ip-192-168-0-11 main[61353]: {&#34;time&#34;:&#34;2022-07-23T08:11:50.855873549Z&#34;,&#34;id&#34;:&#34;&#34;,&#34;remote_ip&#34;:&#34;127.0.0.1&#34;,&#34;host&#34;:&#34;admin.t.isucon.dev&#34;,&#34;method&#34;:&#34;GET&#34;,&#34;uri&#34;:&#34;/api/admin/tenants/billing?before=21&#34;,&#34;user_agent&#34;:&#34;isucandar&#34;,&#34;status&#34;:200,&#34;error&#34;:&#34;&#34;,&#34;latency&#34;:236423007211,&#34;latency_human&#34;:&#34;3m56.423007211s&#34;,&#34;bytes_in&#34;:0,&#34;bytes_out&#34;:1503}
</code></pre></div><p>latencyがやばいのはわかる。原因はおそらくタイムアウトなのでどこかの処理が重いのだろうと思って <code>billing</code> を読む</p>
<p>データベースの初期化部分で <code>init.sh</code> がおかしいのかなと思って直したりした。</p>
<h3 id=1800-終了>18:00 終了</h3>
<p>結局整合性チェックを通せず、終了。得点は <strong>0</strong></p>
<h2 id=反省ポイント>反省ポイント</h2>
<blockquote>
<p>topの挙動が、mysqlが100%を超えている状態からmain(app)が支配的になるという2つのピークがあるように見える→DBを分離したらいいと思って複数台構成に取り掛かる</p>
</blockquote>
<p>これはおそらく初期化でDBが重くなっている。また続くmainのピークも本当にdbの読み書きで重いのか(sqliteのせいなのか)はこの時点で不明。したがって、この考察が間違ってそうであることがわかる。複数台構成はマシン性能を上げるようなもので本質的な改善とは言えないのでここで何かやった気になるのはまずい。</p>
<p>ここではtopだけでは判断できないとしてalpで判断すべき。得点はalpを見てリクエスト数の変化を見たらどう上げたらいいか、点数の内訳がどのエンドポイントへのクエリなのかという構成が分かる。</p>
<blockquote>
<p>大量の.dbファイルを発見してオイオイという気持ちになる。これは絶対MySQLに載せるやつやろと判断する</p>
</blockquote>
<p>sqliteに対して直感で決めているのが良くない。計測で上のtopの挙動からも分かるようにDBやファイルアクセスが支配的とは言えないので後回しでもいい。</p>
<h2 id=わかったこと>わかったこと</h2>
<ul>
<li>計測から得られる結果に対し合理的な判断ができているか、落ち着いて書き出してみた方がいい。時間のロスに気を取られるけど違う選択肢をとってロスする時間の方が大きい。</li>
<li>アプリケーション改善を実質入れられていない。次回はバックアップとったら、秘伝のタレとかインフラとかより先に初手計測してgoのコード変更に注力するように練習で心がけてみる。インフラ系は練習しておけば後からでも間に合いそうなことが分かったのでアプリ中心で改善を入れるようにしてみる。</li>
</ul>
</article>
<footer>
<p class=license>
This document is licensed under
<a href=https://creativecommons.org/licenses/by/4.0/ target=_blank rel="noopener noreferrer">CC-BY-4.0</a>
</p>
<p class=repository>
<a href=https://github.com/uta8a/discussion/discussions/1 target=_blank rel="noopener noreferrer">discussion</a>にコメントする
</p>
</footer>
</main>
</body>
</html>